/*
* Project: AISA
*
* File: QuartzSchedulerListener.java
*
* Created on: Abril 5, 2019 at 11:00
*
* Copyright (c) - Kaz Consulting - 2019
*/

package mx.com.televisa.playcity.background.scheduler;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import org.apache.log4j.Logger;
import org.quartz.CronScheduleBuilder;
import org.quartz.Job;
import org.quartz.JobBuilder;
import org.quartz.JobDetail;
import org.quartz.Scheduler;
import org.quartz.SchedulerException;
import org.quartz.Trigger;
import org.quartz.TriggerBuilder;
import org.quartz.ee.servlet.QuartzInitializerListener;
import org.quartz.impl.StdSchedulerFactory;

/*
* Clase listener que se inicia al arranque de la app  
* y contiene el Quartz Scheduler
*
* @author Kaz Consulting / Jonathan Mariche Catana
*
* @version 1.0.0
*
* @date Abril 5, 2019 at 11:00 am
*/

public class QuartzSchedulerListener implements ServletContextListener {

    private static Scheduler poScheduler;
	private static Logger    poLogger = Logger.getLogger(QuartzSchedulerListener.class);

	//Se ejecuta cuando se detiene la aplicación
    @Override
    public void contextDestroyed(ServletContextEvent toServletContext) {
	    try{	
    		if(poScheduler != null) {	    				       
    			poScheduler.shutdown(false);
	    	}    
    	} catch (Exception toException) {
    		poLogger.error("Error al apagar Quartz scheduler: " 
    				+ toException.getMessage(), toException);    		
    	}
    }

	//Se ejecuta cuando se inicia la aplicación
    @Override
    public void contextInitialized(ServletContextEvent toServletContext) {        
        try {
        	poScheduler = ((StdSchedulerFactory) toServletContext.getServletContext()
                    .getAttribute(QuartzInitializerListener.QUARTZ_FACTORY_KEY))
                    .getScheduler();            
        } catch (SchedulerException toException) {
        	poLogger.error("Error al obtener Quartz scheduler: " 
    				+ toException.getMessage(), toException);
        }
    }
    
    //Crea un job que se ejecuta de acuerdo al plan que se le indica    
    public static void createJob(Class<? extends Job> toJobClass,
    								String tsJobName,
    								String tsTriggerName,
    								CronScheduleBuilder toSchedule,
    								String tsDataProperty){
    	try {
	    	JobDetail loJob = JobBuilder.newJob(toJobClass)
	                .withIdentity(tsJobName, "mainJobGroup").build();
	
	        Trigger loTrigger = TriggerBuilder
	                .newTrigger()
	                .withIdentity(tsTriggerName, "mainTriggerGroup")
	                .usingJobData("dataProperty", tsDataProperty)
	                .startNow()
	                .withSchedule(toSchedule)
	                .build();
	        // Tell quartz to schedule the job using our trigger        
			poScheduler.scheduleJob(loJob, loTrigger);
		} catch (SchedulerException toException) {
			poLogger.error(toException.getStackTrace(),toException);
		}
    }
}