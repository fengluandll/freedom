package mx.javaonline.controlador;

import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import mx.javaonline.model.ConectionWrapper;

import org.apache.log4j.Logger;
import org.primefaces.model.DefaultStreamedContent;
import org.primefaces.model.StreamedContent;

import javax.faces.application.FacesMessage;
import javax.faces.context.FacesContext;  
import javax.naming.NamingException;
import javax.servlet.ServletContext;
import javax.servlet.http.HttpSession;

public class FileDownloadController {
	
	private static org.apache.log4j.Logger logger = Logger.getLogger(FileDownloadController.class);
	ConectionWrapper conectionWrapper;
	Connection con;
	private StreamedContent file; 
	FacesContext facesContext = FacesContext.getCurrentInstance();
	HttpSession session = (HttpSession) facesContext.getExternalContext().getSession(true);

	public FileDownloadController() {
		String topicId = (String)session.getAttribute("topicId");
		String nomArchivo = "";
		InputStream inStream = null;
		try {
			conectionWrapper = new ConectionWrapper();
			con = conectionWrapper.getConexion();
			String sql = "SELECT ct.lamina, \n"+
						 "	     t.topic_name \n"+
						 " FROM  topics t, \n"+
						 "	  content_topics ct \n"+
						 " WHERE ct.topic_id = ? \n"+
						 " AND ct.topic_id = t.topic_id";
		PreparedStatement psmt =  con.prepareStatement(sql);
		logger.debug("select "+sql);
		psmt.setInt(1,Integer.parseInt(topicId));
		ResultSet rs = psmt.executeQuery();
		
		while(rs.next()){
			inStream = rs.getBinaryStream(1);
			nomArchivo = rs.getString(2);
		}
			
		} catch (NamingException | SQLException e) {
			logger.error(e);
		}finally{
			try {
				con.close();
			} catch (SQLException e) {
				logger.error(e);
			}
		}
	  file = new DefaultStreamedContent(inStream, "pdf", nomArchivo);  
	}

	public StreamedContent getFile() {
		return file;
	}
	
	

}
